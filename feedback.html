<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feedback</title>
    <style type="text/css">
      * {
        font-family: "Helvetica Neue";
      }

      table {
        border-collapse: collapse;
        border: 2px solid rgb(200, 200, 200);
        letter-spacing: 1px;
        font-family: sans-serif;
        font-size: 0.8rem;
        margin-top: 50px;
        overflow-y: scroll;
        height: 70vh;
        display: block;
      }

      caption {
        padding: 10px;
        caption-side: top;
      }

      td,
      th {
        border: 1px solid rgb(190, 190, 190);
        padding: 5px 10px;
      }

      td {
        text-align: center;
      }

      thead {
        background-color: #3f87a6;
        color: #fff;
      }

      tbody {
        background-color: #e4f0f5;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center">
      <h1>Lecture Feedback</h1>
      <form id="feedback">
        <select id="teams"></select>
        <select id="sessionLeads">
          <option value="">Select Session Lead</option>
        </select>
        <input type="date" id="sessionDate" />
        <input type="password" id="key" placeholder="Enter key" />
        <input type="submit" value="Feedback" />
      </form>
    </div>
    <div id="showFeedback" style="display: flex; justify-content: center"></div>
    <script type="text/javascript">
      const baseUrl = `https://lecture-feedback.herokuapp.com`;
      let teamsData;

      window.onload = () => {
        fetch(`${baseUrl}/teams`)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            teamsData = data;
            populateTeams(teamsData);
          });
      };

      const teams = document.querySelector("#teams");
      teams.addEventListener("change", (event) => {
        const sessionLeadsSelect = document.querySelector("#sessionLeads");
        const sessionLeads = teamsData.find(
          (team) => team.teamId === event.target.value
        )?.sessionLeads;
        if (!sessionLeads) return;
        sessionLeadsSelect.innerHTML = "";
        const options = sessionLeads
          .map(
            (leadName) =>
              `<option value=${leadName
                .toLowerCase()
                .replaceAll(" ", "-")}>${leadName}</option>`
          )
          .join("");
        sessionLeadsSelect.innerHTML =
          "<option value=''>Choose Session Lead</option>" + options;
      });

      const feedbackForm = document.querySelector("#feedback");
      feedback.addEventListener("submit", (event) => {
        event.preventDefault();
        const feedbackFormFields = event.target.elements;
        const teamId = feedbackFormFields.namedItem("teams").value;
        const sessionLead = feedbackFormFields.namedItem("sessionLeads").value;
        const sessionDate = feedbackFormFields.namedItem("sessionDate").value;
        const key = feedbackFormFields.namedItem("key").value;
        if (teamId || sessionLead || sessionDate) {
          fetch(
            `${baseUrl}/feedback?key=${key}&teamId=${teamId}&sessionLead=${sessionLead}&sessionDate=${sessionDate}`
          )
            .then(function (response) {
              return response.json();
            })
            .then(function (myJson) {
              createFeedbackTable(myJson);
            })
            .catch(function (error) {
              console.log(error);
            });
        }
      });

      function populateTeams(teams) {
        const teamsSelect = document.querySelector("#teams");
        teamsSelect.innerHTML = "";
        const options = teams
          .map(function ({ teamId, name }) {
            return `<option value=${teamId}>${name}</option>`;
          })
          .join("");
        teamsSelect.innerHTML =
          "<option value=''>Select Workspace</option>" + options;
      }

      function createFeedbackTable(data) {
        const ratingMap = {
          0: "Very Poor",
          1: "Poor",
          2: "Average",
          3: "Good",
          4: "Excellent",
        };

        if (data.length > 0) {
          const showFeedback = document.querySelector("#showFeedback");
          showFeedback.innerHTML = "";
          const table = document.createElement("table");
          const tableHead = `
          <thead>
              <tr>
                  <th>Content Delivery</th>
                  <th>Class Preparedness</th>
                  <th>Content Quality</th>
                  <th>Overall Experience</th>
                  <th>Comments</th>
              </tr>
          </thead>`;

          let feedback = "";
          let totalRating = 0;
          let totalContentDeliveryRating = 0;
          let totalClassPreparednessRating = 0;
          let totalContentQualityRating = 0;
          let totalOverallExperienceRating = 0;
          for (const {
            lectureId,
            contentQuality,
            contentDelivery,
            classPreparedness,
            overallExperience,
            userName,
            comments,
          } of data) {
            feedback += `<tr>
                <td>${ratingMap[contentDelivery]}</td>
                <td>${ratingMap[classPreparedness]}</td>
                <td>${ratingMap[contentQuality]}</td>
                <td>${ratingMap[overallExperience]}</td>
                <td>${comments}</td>
            </tr>`;
            totalContentDeliveryRating += Number(contentDelivery);
            totalClassPreparednessRating += Number(classPreparedness);
            totalContentQualityRating += Number(contentQuality);
            totalOverallExperienceRating += Number(overallExperience);
          }

          totalContentDeliveryRating = Math.round(
            totalContentDeliveryRating / data.length
          );
          totalClassPreparednessRating = Math.round(
            totalClassPreparednessRating / data.length
          );
          totalContentQualityRating = Math.round(
            totalContentQualityRating / data.length
          );
          totalOverallExperienceRating = Math.round(
            totalOverallExperienceRating / data.length
          );

          totalRating = Math.round(
            (totalContentDeliveryRating +
              totalClassPreparednessRating +
              totalContentQualityRating +
              totalOverallExperienceRating) /
              4
          );

          feedback += `<tr style="color: white; background-color: #de3163; font-weight: bold">
          <td>Score: ${ratingMap[totalContentDeliveryRating]}</td>
          <td>Score: ${ratingMap[totalClassPreparednessRating]}</td>
          <td>Score: ${ratingMap[totalContentQualityRating]}</td>
          <td>Score: ${ratingMap[totalOverallExperienceRating]}</td>
          <td>Overall Score: ${ratingMap[totalRating]}</td>
          </tr>`;

          table.innerHTML = tableHead + `<tbody>${feedback}</tbody>`;
          showFeedback.appendChild(table);
        }
      }
    </script>
  </body>
</html>
