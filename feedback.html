<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feedback</title>
    <style type="text/css">
      * {
        font-family: "Helvetica Neue";
        margin: 0;
      }

      table {
        border-collapse: collapse;
        border: 2px solid rgb(200, 200, 200);
        letter-spacing: 1px;
        font-family: sans-serif;
        font-size: 0.8rem;
        overflow-y: scroll;
        display: block;
        margin: 0px 50px;
      }

      td,
      th {
        border: 1px solid rgb(190, 190, 190);
        padding: 5px 10px;
      }

      td {
        text-align: center;
      }

      thead {
        background-color: #3f87a6;
        color: #fff;
      }

      tbody {
        background-color: #e4f0f5;
      }

      .title {
        margin: 50px 0px 10px 0px;
        text-align: center;
        color: rgb(73, 115, 150);
      }

      #navbar {
        border: 1px solid black;
        text-align: center;
        background-color: rgb(73, 115, 150);
        color: #fff;
        height: 70px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <h1 id="navbar">Lecture Feedback</h1>
    <div style="text-align: center">
      <h1 class="title">Query</h1>
      <form id="feedback">
        <select id="teams"></select>
        <select id="sessionLeads">
          <option value="">Select Session Lead</option>
        </select>
        <input type="date" id="sessionDate" />
        <input type="password" id="key" placeholder="Enter key" />
        <input type="submit" value="Submit" />
      </form>
    </div>

    <div
      id="showSummary"
      style="display: flex; flex-direction: column; align-items: center"
    ></div>
    <div
      id="showFeedback"
      style="display: flex; flex-direction: column; align-items: center"
    ></div>
    <div style="margin-top: 50px"></div>

    <script type="text/javascript">
      const baseUrl = `https://lecture-feedback.herokuapp.com`;
      let teamsData;

      window.onload = () => {
        fetch(`${baseUrl}/teams`)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            teamsData = data;
            populateTeams(teamsData);
          });
      };

      const teams = document.querySelector("#teams");
      teams.addEventListener("change", (event) => {
        const sessionLeadsSelect = document.querySelector("#sessionLeads");
        const sessionLeads = teamsData.find(
          (team) => team.teamId === event.target.value
        )?.sessionLeads;
        if (!sessionLeads) return;
        sessionLeadsSelect.innerHTML = "";
        const options = sessionLeads
          .map(
            (leadName) =>
              `<option value=${leadName
                .toLowerCase()
                .replaceAll(" ", "-")}>${leadName}</option>`
          )
          .sort()
          .join("");
        sessionLeadsSelect.innerHTML =
          "<option value=''>Choose Session Lead</option>" + options;
      });

      const feedbackForm = document.querySelector("#feedback");
      feedback.addEventListener("submit", (event) => {
        event.preventDefault();
        const feedbackFormFields = event.target.elements;
        const teamId = feedbackFormFields.namedItem("teams").value;
        const sessionLead = feedbackFormFields.namedItem("sessionLeads").value;
        const sessionDate = feedbackFormFields.namedItem("sessionDate").value;
        const key = feedbackFormFields.namedItem("key").value;
        if (teamId || sessionLead || sessionDate) {
          fetch(
            `${baseUrl}/feedback?key=${key}&teamId=${teamId}&sessionLead=${sessionLead}&sessionDate=${sessionDate}`
          )
            .then(function (response) {
              return response.json();
            })
            .then(function (myJson) {
              console.log(myJson);
              createFeedbackTable(myJson);
              showSummaryTable(myJson);
            })
            .catch(function (error) {
              console.log(error);
            });
        }
      });

      function populateTeams(teams) {
        const teamsSelect = document.querySelector("#teams");
        teamsSelect.innerHTML = "";
        const options = teams
          .map(function ({ teamId, name }) {
            return `<option value=${teamId}>${name}</option>`;
          })
          .join("");
        teamsSelect.innerHTML =
          "<option value=''>Select Workspace</option>" + options;
      }

      function createFeedbackTable(data) {
        const ratingMap = {
          0: "Very Poor",
          1: "Poor",
          2: "Average",
          3: "Good",
          4: "Excellent",
        };

        const showFeedback = document.querySelector("#showFeedback");
        showFeedback.innerHTML = "";

        if (data.length > 0) {
          const tableHead = `
          <thead>
              <tr>
                  <th>Content Delivery</th>
                  <th>Class Preparedness</th>
                  <th>Content Quality</th>
                  <th>Overall Experience</th>
                  <th>Comments</th>
              </tr>
          </thead>`;

          let feedback = "";
          for (const {
            contentQuality,
            contentDelivery,
            classPreparedness,
            overallExperience,
            comments,
          } of data) {
            feedback += `<tr>
                <td>${ratingMap[contentDelivery]}</td>
                <td>${ratingMap[classPreparedness]}</td>
                <td>${ratingMap[contentQuality]}</td>
                <td>${ratingMap[overallExperience]}</td>
                <td>${comments}</td>
            </tr>`;
          }
          const title = `<h1 class="title">Detailed Feedback</h1>`;
          showFeedback.innerHTML = `${title}<table>${tableHead}<tbody>${feedback}</tbody></table>`;
        }
      }

      function showSummaryTable(data) {
        const ratingMap = {
          0: "Very Poor",
          1: "Poor",
          2: "Average",
          3: "Good",
          4: "Excellent",
        };

        const showSummary = document.querySelector("#showSummary");
        showSummary.innerHTML = "";

        if (data.length > 0) {
          const tableHead = `
          <thead>
              <tr>
                  <th>Total Feedbacks Collected</th>
                  <th>Content Delivery</th>
                  <th>Class Preparedness</th>
                  <th>Content Quality</th>
                  <th>Overall Experience</th>
              </tr>
          </thead>`;

          let totalContentDeliveryRating = 0;
          let totalClassPreparednessRating = 0;
          let totalContentQualityRating = 0;
          let totalOverallExperienceRating = 0;

          for (const {
            contentDelivery,
            classPreparedness,
            contentQuality,
            overallExperience,
          } of data) {
            totalContentDeliveryRating += Number(contentDelivery);
            totalClassPreparednessRating += Number(classPreparedness);
            totalContentQualityRating += Number(contentQuality);
            totalOverallExperienceRating += Number(overallExperience);
          }

          totalContentDeliveryRating = Math.round(
            totalContentDeliveryRating / data.length
          );
          totalClassPreparednessRating = Math.round(
            totalClassPreparednessRating / data.length
          );
          totalContentQualityRating = Math.round(
            totalContentQualityRating / data.length
          );
          totalOverallExperienceRating = Math.round(
            totalOverallExperienceRating / data.length
          );

          const summaryStats = `<tr>
                <td>${data.length}</td>
                <td>${ratingMap[totalContentDeliveryRating]}</td>
                <td>${ratingMap[totalClassPreparednessRating]}</td>
                <td>${ratingMap[totalContentQualityRating]}</td>
                <td>${ratingMap[totalOverallExperienceRating]}</td>
            </tr>`;

          const title = `<h1 class="title">Summary</h1>`;
          showSummary.innerHTML = `${title}<table>${tableHead}<tbody>${summaryStats}</tbody></table>`;
        }
      }
    </script>
  </body>
</html>
